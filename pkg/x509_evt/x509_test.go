package x509_evt

import (
	"encoding/pem"
	"github.com/cloudflare/circl/kem/mlkem/mlkem512"
	"github.com/cloudflare/circl/sign/slhdsa"
	"reflect"
	"testing"
)

func TestParseCertificate(t *testing.T) {
	tcs := []struct {
		name            string
		certPem         string
		expectedKeyType reflect.Type
	}{
		{
			name: "slh-dsa certificate",
			certPem: `-----BEGIN CERTIFICATE-----
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
AAAKEBkiJCw=
-----END CERTIFICATE-----`,
			expectedKeyType: reflect.TypeOf(slhdsa.PublicKey{}),
		},
		{
			name: "ml kem certificate",
			certPem: `-----BEGIN CERTIFICATE-----
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
-----END CERTIFICATE-----`,
			expectedKeyType: reflect.TypeOf(&mlkem512.PublicKey{}),
		},
	}

	for _, tc := range tcs {
		t.Run(tc.name, func(t *testing.T) {

			block, _ := pem.Decode([]byte(tc.certPem))
			cert, err := ParseCertificate(block.Bytes)
			if err != nil {
				t.Fatalf("expected no error, got: %v", err)
			} else {
				if reflect.TypeOf(cert.PublicKey) != tc.expectedKeyType {
					t.Fatalf("expected %v, got %T", tc.expectedKeyType, cert.PublicKey)
				}
			}
		})
	}
}
